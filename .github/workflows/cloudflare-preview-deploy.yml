name: Cloudflare Preview Deploy

on:
    workflow_dispatch:
        inputs:
            pr_number:
                description: "PR number to deploy"
                required: true
                type: string
            action:
                description: "Action to perform"
                required: true
                type: choice
                options:
                    - deploy
                    - delete
                default: deploy
    issue_comment:
        types: [created]

concurrency:
    group: cloudflare-preview-${{ github.event.inputs.pr_number || github.event.issue.number }}
    cancel-in-progress: true

jobs:
    # Check if comment triggers deployment
    check-comment:
        name: Check Comment Trigger
        runs-on: ubuntu-latest
        if: github.event_name == 'issue_comment'
        outputs:
            should_deploy: ${{ steps.check.outputs.should_deploy }}
            pr_number: ${{ steps.check.outputs.pr_number }}
        steps:
            - name: Check comment and permissions
              id: check
              uses: actions/github-script@v7
              with:
                  script: |
                      const comment = context.payload.comment.body.trim();
                      const author = context.payload.comment.user.login;

                      console.log(`Comment: "${comment}" by ${author}`);

                      // Check if comment is a deploy command
                      if (!comment.startsWith('/deploy-preview')) {
                        console.log('Not a deploy command');
                        return;
                      }

                      // Check if this is a PR (not an issue)
                      if (!context.payload.issue.pull_request) {
                        console.log('Comment is not on a PR');
                        return;
                      }

                      console.log(`Processing deploy command for PR #${context.payload.issue.number}`);

                      // Get PR details
                      const { data: pr } = await github.rest.pulls.get({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        pull_number: context.payload.issue.number
                      });

                      console.log(`PR details: ${pr.title} (${pr.state})`);

                      // Check if author has write permissions (maintainer)
                      try {
                        const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          username: author
                        });
                        
                        console.log(`User ${author} has permission: ${permission.permission}`);
                        
                        const hasPermission = ['admin', 'maintain', 'write'].includes(permission.permission);
                        
                        if (!hasPermission) {
                          console.log(`Permission denied for ${author}`);
                          
                          await github.rest.reactions.createForIssueComment({
                            owner: context.repo.owner,
                            repo: context.repo.repo,
                            comment_id: context.payload.comment.id,
                            content: '-1'
                          });
                          
                          await github.rest.issues.createComment({
                            owner: context.repo.owner,
                            repo: context.repo.repo,
                            issue_number: context.payload.issue.number,
                            body: `‚ùå @${author} You don't have permission to deploy previews. Only maintainers can trigger deployments.`
                          });
                          
                          return;
                        }
                        
                        console.log(`Permission granted for ${author}, starting deployment`);
                        
                        // React with rocket to indicate deployment started
                        await github.rest.reactions.createForIssueComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          comment_id: context.payload.comment.id,
                          content: 'rocket'
                        });
                        
                        core.setOutput('should_deploy', 'true');
                        core.setOutput('pr_number', context.payload.issue.number.toString());
                        
                      } catch (error) {
                        console.log(`Error checking permissions: ${error.message}`);
                        await github.rest.reactions.createForIssueComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          comment_id: context.payload.comment.id,
                          content: '-1'
                        });
                      }

  # Main deployment job
  deploy:
    name: Deploy Preview
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'issue_comment' && needs.check-comment.outputs.should_deploy == 'true')
    needs: [check-comment]
    env:
      PR_NUMBER: ${{ github.event.inputs.pr_number || needs.check-comment.outputs.pr_number }}
    
    steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Get PR details
              id: pr
              uses: actions/github-script@v7
              with:
                  script: |
                      const { data: pr } = await github.rest.pulls.get({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        pull_number: parseInt(process.env.PR_NUMBER)
                      });

                      core.setOutput('branch', pr.head.ref);
                      core.setOutput('sha', pr.head.sha);
                      core.setOutput('title', pr.title);

            - name: Checkout PR branch
              run: |
                  git fetch origin ${{ steps.pr.outputs.branch }}
                  git checkout ${{ steps.pr.outputs.sha }}

            - name: Install pnpm
              uses: pnpm/action-setup@v2
              with:
                  version: 9

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "18"
                  cache: "pnpm"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Build admin app
              run: pnpm --filter admin run build

            - name: Deploy to Cloudflare Pages
              id: deploy
              if: github.event.inputs.action != 'delete'
              uses: cloudflare/pages-action@v1
              with:
                  apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
                  accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
                  projectName: ${{ secrets.CLOUDFLARE_PROJECT_NAME }}
                  directory: apps/admin/dist
                  gitHubToken: ${{ secrets.GITHUB_TOKEN }}
                  branch: ${{ steps.pr.outputs.branch }}

            - name: Delete Cloudflare deployment
              if: github.event.inputs.action == 'delete'
              uses: actions/github-script@v7
              with:
                  script: |
                      const fetch = require('node-fetch');

                      const accountId = process.env.CLOUDFLARE_ACCOUNT_ID;
                      const projectName = process.env.CLOUDFLARE_PROJECT_NAME;
                      const apiToken = process.env.CLOUDFLARE_API_TOKEN;
                      const branch = process.env.BRANCH;

                      // Get deployments
                      const response = await fetch(
                        `https://api.cloudflare.com/client/v4/accounts/${accountId}/pages/projects/${projectName}/deployments`,
                        {
                          headers: {
                            'Authorization': `Bearer ${apiToken}`,
                            'Content-Type': 'application/json'
                          }
                        }
                      );

                      const data = await response.json();

                      if (!data.success) {
                        throw new Error(`Failed to get deployments: ${JSON.stringify(data.errors)}`);
                      }

                      // Find deployments for this branch
                      const branchDeployments = data.result.filter(d => 
                        d.deployment_trigger?.metadata?.branch === branch || 
                        d.source?.metadata?.branch === branch
                      );

                      console.log(`Found ${branchDeployments.length} deployments for branch ${branch}`);

                      // Delete each deployment
                      for (const deployment of branchDeployments) {
                        const deleteResponse = await fetch(
                          `https://api.cloudflare.com/client/v4/accounts/${accountId}/pages/projects/${projectName}/deployments/${deployment.id}`,
                          {
                            method: 'DELETE',
                            headers: {
                              'Authorization': `Bearer ${apiToken}`,
                              'Content-Type': 'application/json'
                            }
                          }
                        );
                        
                        const deleteData = await deleteResponse.json();
                        
                        if (deleteData.success) {
                          console.log(`‚úÖ Deleted deployment ${deployment.id}`);
                        } else {
                          console.log(`‚ùå Failed to delete deployment ${deployment.id}: ${JSON.stringify(deleteData.errors)}`);
                        }
                      }
              env:
                  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
                  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
                  CLOUDFLARE_PROJECT_NAME: ${{ secrets.CLOUDFLARE_PROJECT_NAME }}
                  BRANCH: ${{ steps.pr.outputs.branch }}

            - name: Comment on PR
              uses: actions/github-script@v7
              with:
                  script: |
                      const prNumber = parseInt(process.env.PR_NUMBER);
                      const action = process.env.ACTION || 'deploy';
                      const deployUrl = process.env.DEPLOY_URL;
                      const branch = process.env.BRANCH;
                      const sha = process.env.SHA;

                      let body;

                      if (action === 'delete') {
                        body = `üóëÔ∏è **Preview Deleted**
                        
                        Preview deployments for branch \`${branch}\` have been removed.`;
                      } else if (deployUrl) {
                        body = `üöÄ **Preview Deployed Successfully**
                        
                        **Preview URL:** ${deployUrl}
                        **Branch:** \`${branch}\`
                        **Commit:** \`${sha}\`
                        
                        > Preview will be automatically cleaned up when this PR is closed.`;
                      } else {
                        body = `‚ùå **Preview Deployment Failed**
                        
                        There was an issue deploying the preview. Please check the workflow logs for details.`;
                      }

                      await github.rest.issues.createComment({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: prNumber,
                        body: body
                      });
              env:
                  PR_NUMBER: ${{ env.PR_NUMBER }}
                  ACTION: ${{ github.event.inputs.action }}
                  DEPLOY_URL: ${{ steps.deploy.outputs.url }}
                  BRANCH: ${{ steps.pr.outputs.branch }}
                  SHA: ${{ steps.pr.outputs.sha }}
